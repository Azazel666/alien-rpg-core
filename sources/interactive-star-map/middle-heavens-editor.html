<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middle Heavens Map - POI Editor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100vw;
            background: #000;
        }

        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(10, 10, 20, 0.95);
            border: 2px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            min-width: 280px;
            max-width: 320px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .control-panel h2 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 18px;
            text-transform: uppercase;
            border-bottom: 1px solid #00ff88;
            padding-bottom: 8px;
        }

        .btn {
            width: 100%;
            padding: 10px 15px;
            margin: 5px 0;
            border: 2px solid #00ff88;
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .btn.active {
            background: #00ff88;
            color: #000;
        }

        .btn.danger {
            border-color: #ff4444;
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }

        .btn.danger:hover {
            background: rgba(255, 68, 68, 0.2);
        }

        .poi-count {
            font-size: 14px;
            color: #88ffaa;
            margin: 10px 0;
            text-align: center;
            padding: 8px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 5px;
        }

        .section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 255, 136, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(10, 10, 20, 0.98);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }

        .modal-content h3 {
            color: #00ff88;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #88ffaa;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff88;
            border-radius: 5px;
            color: #fff;
            font-family: inherit;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00ffaa;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: 2px solid;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .modal-buttons .btn-save {
            background: #00ff88;
            border-color: #00ff88;
            color: #000;
        }

        .modal-buttons .btn-save:hover {
            background: #00ffaa;
        }

        .modal-buttons .btn-cancel {
            background: transparent;
            border-color: #666;
            color: #999;
        }

        .modal-buttons .btn-cancel:hover {
            border-color: #888;
            color: #ccc;
        }

        /* Custom popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(10, 10, 20, 0.98);
            border: 2px solid #00ff88;
            border-radius: 5px;
            color: #fff;
        }

        .leaflet-popup-content {
            margin: 15px;
            min-width: 200px;
        }

        .leaflet-popup-content h3 {
            color: #00ffff;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .leaflet-popup-tip {
            background: rgba(10, 10, 20, 0.98);
            border: 2px solid #00ff88;
        }

        .popup-info {
            margin: 5px 0;
            font-size: 13px;
        }

        .popup-label {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
        }

        .popup-value {
            color: #88ffaa;
        }

        .popup-buttons {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .popup-buttons button {
            flex: 1;
            padding: 6px;
            border: 1px solid;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            font-weight: bold;
        }

        .popup-btn-edit {
            background: rgba(0, 136, 255, 0.2);
            border-color: #0088ff;
            color: #0088ff;
        }

        .popup-btn-edit:hover {
            background: rgba(0, 136, 255, 0.4);
        }

        .popup-btn-delete {
            background: rgba(255, 68, 68, 0.2);
            border-color: #ff4444;
            color: #ff4444;
        }

        .popup-btn-delete:hover {
            background: rgba(255, 68, 68, 0.4);
        }

        small {
            display: block;
            margin-top: 10px;
            color: #666;
            font-size: 11px;
            line-height: 1.4;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
            text-align: center;
        }

        .status-message.success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .status-message.error {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        /* Scrollbar styling */
        .control-panel::-webkit-scrollbar {
            width: 8px;
        }

        .control-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <h2>üó∫Ô∏è POI Editor</h2>
        
        <button id="toggleAddMode" class="btn">
            ‚úèÔ∏è Click to Add POI
        </button>

        <div class="poi-count">
            Total POIs: <span id="poiCount">0</span>
        </div>

        <div class="section">
            <button id="exportData" class="btn">
                üíæ Save to map-data.json
            </button>
        </div>

        <div class="section">
            <button id="clearAll" class="btn danger">
                üóëÔ∏è Clear All POIs
            </button>
        </div>

        <div id="statusMessage"></div>

        <small>
            ‚Ä¢ Auto-loads map-data.json on startup<br>
            ‚Ä¢ Toggle "Add POI" then click the map to place markers<br>
            ‚Ä¢ Click existing markers to edit or delete<br>
            ‚Ä¢ Save exports to map-data.json (move to same folder)
        </small>
    </div>

    <!-- Modal for adding/editing POI -->
    <div id="poiModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Add New POI</h3>
            <form id="poiForm">
                <div class="form-group">
                    <label>System Code</label>
                    <input type="text" id="poiCode" placeholder="e.g., SOL-001">
                    <small style="color: #888; margin-top: 4px;">Either Code or Name must be filled</small>
                </div>

                <div class="form-group">
                    <label>System Name</label>
                    <input type="text" id="poiName" placeholder="e.g., Sol">
                    <small style="color: #888; margin-top: 4px;">Either Code or Name must be filled</small>
                </div>
                
                <div class="form-group">
                    <label>Type *</label>
                    <select id="poiType" required>
                        <option value="">-- Select Type --</option>
                        <option value="Star System">Star System</option>
                        <option value="Planet">Planet</option>
                        <option value="Moon">Moon</option>
                        <option value="Colony">Colony</option>
                        <option value="Outpost">Outpost</option>
                        <option value="Station">Station</option>
                        <option value="Gateway">Gateway</option>
                        <option value="Military Base">Military Base</option>
                        <option value="Research Facility">Research Facility</option>
                        <option value="Mining Operation">Mining Operation</option>
                        <option value="Waypoint">Waypoint</option>
                        <option value="Capital">Capital</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Territory *</label>
                    <select id="poiTerritory" required>
                        <option value="">-- Select Territory --</option>
                        <option value="UPP">Union of Progressive Peoples</option>
                        <option value="TWE">Three World Empire</option>
                        <option value="ICSC">Independent Core System Colonies</option>
                        <option value="UA">United Americas</option>
                        <option value="Frontier">Frontier</option>
                        <option value="Neutral">Neutral/Unclaimed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Destinations (Planets, Moons, Stations in this system)</label>
                    <div id="destinationsList" style="max-height: 150px; overflow-y: auto; border: 1px solid #00ff88; border-radius: 5px; padding: 8px; background: rgba(0, 0, 0, 0.3); margin-bottom: 8px;">
                        <div style="color: #666; font-size: 12px; text-align: center;">No destinations added</div>
                    </div>
                    <button type="button" id="addDestination" class="btn" style="padding: 8px; font-size: 12px; margin: 0;">
                        ‚ûï Add Destination
                    </button>
                </div>

                <div class="modal-buttons">
                    <button type="submit" class="btn-save">Save POI</button>
                    <button type="button" class="btn-cancel" id="cancelModal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for adding destination -->
    <div id="destinationModal" class="modal">
        <div class="modal-content" style="max-width: 350px;">
            <h3 id="destinationModalTitle">Add Destination</h3>
            <form id="destinationForm">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="destName" required placeholder="e.g., Lucien">
                </div>
                
                <div class="form-group">
                    <label>Type *</label>
                    <select id="destType" required>
                        <option value="">-- Select Type --</option>
                        <option value="Planet">Planet</option>
                        <option value="Moon">Moon</option>
                        <option value="Station">Station</option>
                        <option value="Outpost">Outpost</option>
                        <option value="Colony">Colony</option>
                        <option value="Gateway">Gateway</option>
                        <option value="Research Facility">Research Facility</option>
                        <option value="Mining Operation">Mining Operation</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="modal-buttons">
                    <button type="submit" class="btn-save">Add</button>
                    <button type="button" class="btn-cancel" id="cancelDestModal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize map
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -1,
            maxZoom: 3,
            zoomControl: true,
            attributionControl: false
        });

        // Image dimensions and bounds
        const imageWidth = 1920;
        const imageHeight = 1080;
        const bounds = [[0, 0], [imageHeight, imageWidth]];

        // Load the star map image
        const imageUrl = 'Stars_Of_The_Middle_Heavens_2183.jpg';
        L.imageOverlay(imageUrl, bounds).addTo(map);
        map.fitBounds(bounds);
        map.setView([imageHeight / 2, imageWidth / 2], 0);

        // Territory colors
        const territoryColors = {
            'UPP': '#CD853F',
            'TWE': '#3CB371',
            'ICSC': '#9ACD32',
            'UA': '#4169E1',
            'Frontier': '#BA55D3',
            'Neutral': '#888888'
        };

        // State
        let addMode = false;
        let pois = [];
        let markers = [];
        let currentEditingPoi = null;
        let currentDestinations = []; // Temporary storage for destinations being edited
        let editingDestinationIndex = null;

        // Create custom icon
        function createCustomIcon(color, size = 12) {
            return L.divIcon({
                className: 'custom-icon',
                html: `<div style="width: ${size}px; height: ${size}px; background: ${color}; border: 2px solid rgba(255, 255, 255, 0.9); border-radius: 50%; box-shadow: 0 0 12px ${color};"></div>`,
                iconSize: [size + 4, size + 4],
                iconAnchor: [size / 2 + 2, size / 2 + 2],
                popupAnchor: [0, -size / 2 - 2]
            });
        }

        // Toggle add mode
        document.getElementById('toggleAddMode').addEventListener('click', function() {
            addMode = !addMode;
            this.classList.toggle('active', addMode);
            this.textContent = addMode ? '‚úì Adding POI (Click Map)' : '‚úèÔ∏è Click to Add POI';
            map.getContainer().style.cursor = addMode ? 'crosshair' : '';
        });

        // Map click to add POI
        map.on('click', function(e) {
            if (!addMode) return;

            currentEditingPoi = {
                coords: [e.latlng.lat, e.latlng.lng],
                isNew: true
            };
            currentDestinations = [];
            
            document.getElementById('modalTitle').textContent = 'Add New POI';
            document.getElementById('poiForm').reset();
            renderDestinationsList();
            document.getElementById('poiModal').classList.add('show');
        });

        // Form submission
        document.getElementById('poiForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const code = document.getElementById('poiCode').value.trim();
            const name = document.getElementById('poiName').value.trim();

            // Validate that at least one of code or name is filled
            if (!code && !name) {
                showStatus('Either System Code or System Name must be filled!', 'error');
                return;
            }

            const poi = {
                id: currentEditingPoi.isNew ? Date.now() : currentEditingPoi.id,
                coords: currentEditingPoi.coords,
                code: code,
                name: name,
                type: document.getElementById('poiType').value,
                territory: document.getElementById('poiTerritory').value,
                destinations: [...currentDestinations] // Store destinations
            };

            if (currentEditingPoi.isNew) {
                pois.push(poi);
                showStatus('POI added successfully!', 'success');
            } else {
                const index = pois.findIndex(p => p.id === poi.id);
                if (index !== -1) {
                    pois[index] = poi;
                    showStatus('POI updated successfully!', 'success');
                }
            }

            renderMarkers();
            closeModal();
            
            // Turn off add mode
            addMode = false;
            document.getElementById('toggleAddMode').classList.remove('active');
            document.getElementById('toggleAddMode').textContent = '‚úèÔ∏è Click to Add POI';
            map.getContainer().style.cursor = '';
        });

        // Cancel modal
        document.getElementById('cancelModal').addEventListener('click', closeModal);

        function closeModal() {
            document.getElementById('poiModal').classList.remove('show');
            currentEditingPoi = null;
            currentDestinations = [];
        }

        // Destinations management
        function renderDestinationsList() {
            const listEl = document.getElementById('destinationsList');
            
            if (currentDestinations.length === 0) {
                listEl.innerHTML = '<div style="color: #666; font-size: 12px; text-align: center;">No destinations added</div>';
                return;
            }
            
            listEl.innerHTML = currentDestinations.map((dest, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px; margin: 4px 0; background: rgba(0, 255, 136, 0.1); border-radius: 3px;">
                    <div style="flex: 1;">
                        <div style="color: #00ffff; font-size: 13px; font-weight: bold;">${dest.name}</div>
                        <div style="color: #888; font-size: 11px;">${dest.type}</div>
                    </div>
                    <div>
                        <button onclick="editDestination(${index})" style="padding: 4px 8px; margin-right: 4px; background: rgba(0, 136, 255, 0.2); border: 1px solid #0088ff; color: #0088ff; border-radius: 3px; cursor: pointer; font-size: 11px;">Edit</button>
                        <button onclick="deleteDestination(${index})" style="padding: 4px 8px; background: rgba(255, 68, 68, 0.2); border: 1px solid #ff4444; color: #ff4444; border-radius: 3px; cursor: pointer; font-size: 11px;">Del</button>
                    </div>
                </div>
            `).join('');
        }

        // Add destination button
        document.getElementById('addDestination').addEventListener('click', function() {
            editingDestinationIndex = null;
            document.getElementById('destinationModalTitle').textContent = 'Add Destination';
            document.getElementById('destinationForm').reset();
            document.getElementById('destinationModal').classList.add('show');
        });

        // Edit destination
        window.editDestination = function(index) {
            editingDestinationIndex = index;
            const dest = currentDestinations[index];
            document.getElementById('destinationModalTitle').textContent = 'Edit Destination';
            document.getElementById('destName').value = dest.name;
            document.getElementById('destType').value = dest.type;
            document.getElementById('destinationModal').classList.add('show');
        };

        // Delete destination
        window.deleteDestination = function(index) {
            if (!confirm('Delete this destination?')) return;
            currentDestinations.splice(index, 1);
            renderDestinationsList();
        };

        // Destination form submission
        document.getElementById('destinationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dest = {
                name: document.getElementById('destName').value.trim(),
                type: document.getElementById('destType').value
            };
            
            if (editingDestinationIndex !== null) {
                currentDestinations[editingDestinationIndex] = dest;
            } else {
                currentDestinations.push(dest);
            }
            
            renderDestinationsList();
            document.getElementById('destinationModal').classList.remove('show');
        });

        // Cancel destination modal
        document.getElementById('cancelDestModal').addEventListener('click', function() {
            document.getElementById('destinationModal').classList.remove('show');
        });

        // Render all markers
        function renderMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Add new markers
            pois.forEach(poi => {
                const color = territoryColors[poi.territory] || '#888888';
                const hasDestinations = poi.destinations && poi.destinations.length > 0;
                const marker = L.marker(poi.coords, {
                    icon: createCustomIcon(color, hasDestinations ? 16 : 12)
                }).addTo(map);

                const territoryNames = {
                    'UPP': 'Union of Progressive Peoples',
                    'TWE': 'Three World Empire',
                    'ICSC': 'Independent Core System Colonies',
                    'UA': 'United Americas',
                    'Frontier': 'Frontier',
                    'Neutral': 'Neutral/Unclaimed'
                };

                let destinationsHTML = '';
                if (hasDestinations) {
                    destinationsHTML = `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0, 255, 136, 0.3);">
                            <div class="popup-label" style="margin-bottom: 8px;">Destinations (${poi.destinations.length}):</div>
                            ${poi.destinations.map(dest => `
                                <div style="margin: 4px 0; padding: 4px 8px; background: rgba(0, 255, 136, 0.1); border-radius: 3px;">
                                    <span style="color: #00ffff; font-size: 12px; font-weight: bold;">${dest.name}</span>
                                    <span style="color: #888; font-size: 11px; margin-left: 8px;">${dest.type}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                const displayName = poi.name || poi.code || 'Unknown';
                
                const popupContent = `
                    <h3>${displayName}</h3>
                    ${poi.code && poi.name ? `<div class="popup-info">
                        <span class="popup-label">Code:</span>
                        <span class="popup-value">${poi.code}</span>
                    </div>` : ''}
                    <div class="popup-info">
                        <span class="popup-label">Type:</span>
                        <span class="popup-value">${poi.type}</span>
                    </div>
                    <div class="popup-info">
                        <span class="popup-label">Territory:</span>
                        <span class="popup-value">${territoryNames[poi.territory]}</span>
                    </div>
                    ${destinationsHTML}
                    <div class="popup-buttons">
                        <button class="popup-btn-edit" onclick="editPoi(${poi.id})">Edit</button>
                        <button class="popup-btn-delete" onclick="deletePoi(${poi.id})">Delete</button>
                    </div>
                `;

                marker.bindPopup(popupContent, { maxWidth: 300 });
                markers.push(marker);
            });

            updatePoiCount();
        }

        // Edit POI
        window.editPoi = function(id) {
            const poi = pois.find(p => p.id === id);
            if (!poi) return;

            currentEditingPoi = { ...poi, isNew: false };
            currentDestinations = poi.destinations ? [...poi.destinations] : [];
            
            document.getElementById('modalTitle').textContent = 'Edit POI';
            document.getElementById('poiCode').value = poi.code;
            document.getElementById('poiName').value = poi.name;
            document.getElementById('poiType').value = poi.type;
            document.getElementById('poiTerritory').value = poi.territory;
            
            renderDestinationsList();
            
            document.getElementById('poiModal').classList.add('show');
        };

        // Delete POI
        window.deletePoi = function(id) {
            if (!confirm('Delete this POI? This cannot be undone.')) return;
            
            pois = pois.filter(p => p.id !== id);
            renderMarkers();
            showStatus('POI deleted', 'success');
        };

        // Update POI count
        function updatePoiCount() {
            document.getElementById('poiCount').textContent = pois.length;
        }

        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            
            setTimeout(() => {
                statusEl.textContent = '';
                statusEl.className = '';
            }, 3000);
        }

        // Export data
        document.getElementById('exportData').addEventListener('click', function() {
            const data = {
                version: '1.0',
                map: 'Stars of the Middle Heavens 2183',
                exported: new Date().toISOString(),
                imageBounds: bounds,
                pois: pois.map(poi => ({
                    code: poi.code,
                    name: poi.name,
                    type: poi.type,
                    territory: poi.territory,
                    coords: poi.coords,
                    destinations: poi.destinations || []
                }))
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'map-data.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('POI data exported to map-data.json!', 'success');
        });

        // Clear all
        document.getElementById('clearAll').addEventListener('click', function() {
            if (!confirm('Delete ALL POIs? This cannot be undone!')) return;
            
            pois = [];
            renderMarkers();
            showStatus('All POIs cleared', 'success');
        });

        // Auto-load map-data.json on startup
        function autoLoadMapData() {
            fetch('map-data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('map-data.json not found');
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.pois || !Array.isArray(data.pois)) {
                        throw new Error('Invalid POI data format');
                    }

                    // Import POIs with new IDs
                    pois = data.pois.map((poi, index) => ({
                        id: Date.now() + index,
                        code: poi.code || '',
                        name: poi.name || 'Unknown',
                        type: poi.type || 'Other',
                        territory: poi.territory || 'Neutral',
                        coords: poi.coords || [540, 960],
                        destinations: poi.destinations || []
                    }));

                    renderMarkers();
                    showStatus(`Loaded ${pois.length} POIs from map-data.json`, 'success');
                })
                .catch(error => {
                    console.log('Could not auto-load map-data.json:', error.message);
                    showStatus('Starting with empty map (map-data.json not found)', 'info');
                });
        }

        // Auto-load on page load
        autoLoadMapData();

        console.log('Middle Heavens POI Editor ready!');
    </script>
</body>
</html>